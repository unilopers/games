<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Gerenciar Pedidos</title>
</head>
<body>

<div>
    <nav>
        <a href="pedidos.html">Pedidos</a>
        <a href="itens-pedido.html">Itens</a>
        <a href="lista-desejos.html">Desejos</a>
        <a href="chaves-digitais.html">Chaves</a>
    </nav>

    <div>
        <h2 id="form-titulo">Novo Pedido</h2>
        <input type="hidden" id="id-pedido">
        <div>
            <div>
                <label>ID Usu√°rio</label>
                <input type="number" id="usuarioId">
            </div>
            <div>
                <label>Status</label>
                <select id="status">
                    <option value="PENDENTE">Pendente</option>
                    <option value="PAGO">Pago</option>
                    <option value="PROCESSANDO">Processando</option>
                    <option value="ENVIADO">Enviado</option>
                    <option value="CONCLUIDO">Conclu√≠do</option>
                    <option value="CANCELADO">Cancelado</option>
                    <option value="REEMBOLSADO">Reembolsado</option>
                </select>
            </div>
            <div>
                <label>M√©todo Pagamento</label>
                <input type="text" id="metodo" placeholder="Ex: Cart√£o de Cr√©dito">
            </div>
            <div>
                <label>ID Endere√ßo Entrega</label>
                <input type="number" id="enderecoId">
            </div>
            <div>
                <label>Valor Total (R$)</label>
                <input type="number" step="0.01" id="valorTotal" value="0.00">
            </div>
        </div>
        <div>
            <button id="btn-salvar" onclick="salvarPedido()">Salvar Pedido</button>
            <button id="btn-cancelar" onclick="limparFormulario()">Cancelar</button>
        </div>
    </div>

    <div>
        <h2>Pedidos Recentes</h2>
        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>Usu√°rio</th>
                <th>Status</th>
                <th>Total</th>
                <th>A√ß√µes</th>
            </tr>
            </thead>
            <tbody id="tabela-pedidos"></tbody>
        </table>
    </div>
</div>

<script>
    const API_URL = '/pedidos';

    function getXmlValue(node, tagName) {
        const tag = node.querySelector(tagName);
        return tag ? tag.textContent : '';
    }

    function getNestedId(node, parentTag) {
        const parent = node.querySelector(parentTag);
        if (parent) {
            return getXmlValue(parent, 'id') || getXmlValue(parent, 'usuario_id') || '';
        }
        return '';
    }

    async function carregarPedidos() {
        try {
            const response = await fetch(API_URL, { headers: { 'Accept': 'application/xml' } });
            const text = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(text, "text/xml");
            const nodes = xmlDoc.querySelectorAll("pedido, item");

            const tbody = document.getElementById('tabela-pedidos');
            tbody.innerHTML = '';

            nodes.forEach(node => {
                const id = getXmlValue(node, 'id');
                const status = getXmlValue(node, 'status');
                const valorTotal = getXmlValue(node, 'valorTotal');
                const metodo = getXmlValue(node, 'metodoPagamento');

                const usuarioId = getNestedId(node, 'usuario');
                const enderecoId = getNestedId(node, 'enderecoEntrega');

                const obj = { id, usuarioId, status, valorTotal, metodo, enderecoId };
                const objString = JSON.stringify(obj).replace(/"/g, '&quot;');

                tbody.innerHTML += `
                    <tr>
                        <td>${id}</td>
                        <td>ID: ${usuarioId}</td>
                        <td>${status}</td>
                        <td>R$ ${valorTotal}</td>
                        <td>
                            <button class="btn-edit" onclick="prepararEdicao(${objString})">‚úèÔ∏è</button>
                            <button class="btn-delete" onclick="deletarPedido(${id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
        } catch(e) { console.error(e); }
    }

    function prepararEdicao(pedido) {
        document.getElementById('id-pedido').value = pedido.id;
        document.getElementById('usuarioId').value = pedido.usuarioId;
        document.getElementById('status').value = pedido.status;
        document.getElementById('metodo').value = pedido.metodo;
        document.getElementById('enderecoId').value = pedido.enderecoId;
        document.getElementById('valorTotal').value = pedido.valorTotal;

        document.getElementById('form-titulo').innerText = 'Editar Pedido #' + pedido.id;
        document.getElementById('btn-salvar').innerText = 'Atualizar';
        document.getElementById('btn-cancelar').style.display = 'block';
    }

    function limparFormulario() {
        document.getElementById('id-pedido').value = '';
        document.getElementById('usuarioId').value = '';
        document.getElementById('status').value = 'PENDENTE';
        document.getElementById('metodo').value = '';
        document.getElementById('enderecoId').value = '';
        document.getElementById('valorTotal').value = '0.00';

        document.getElementById('form-titulo').innerText = 'Novo Pedido';
        document.getElementById('btn-salvar').innerText = 'Salvar Pedido';
        document.getElementById('btn-cancelar').style.display = 'none';
    }

    async function salvarPedido() {
        const id = document.getElementById('id-pedido').value;
        const usuarioId = document.getElementById('usuarioId').value;
        const status = document.getElementById('status').value;
        const metodo = document.getElementById('metodo').value;
        const enderecoId = document.getElementById('enderecoId').value;
        const valorTotal = document.getElementById('valorTotal').value;

        const xmlBody = `
            <pedido>
                ${id ? `<id>${id}</id>` : ''}
                <status>${status}</status>
                <metodoPagamento>${metodo}</metodoPagamento>
                <valorTotal>${valorTotal}</valorTotal>
                ${usuarioId ? `<usuario><id>${usuarioId}</id></usuario>` : ''}
                ${enderecoId ? `<enderecoEntrega><id>${enderecoId}</id></enderecoEntrega>` : ''}
            </pedido>
        `;

        let url = API_URL;
        let method = 'POST';
        if (id) { url = `${API_URL}/${id}`; method = 'PUT'; }

        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/xml', 'Accept': 'application/xml' },
                body: xmlBody
            });
            if (res.ok) {
                alert('Sucesso!');
                limparFormulario();
                carregarPedidos();
            } else {
                alert('Erro ao salvar.');
                console.log(await res.text());
            }
        } catch(e) { console.error(e); }
    }

    async function deletarPedido(id) {
        if(confirm('Apagar?')) {
            await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
            carregarPedidos();
        }
    }

    carregarPedidos();
</script>
</body>
</html>