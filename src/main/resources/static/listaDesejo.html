<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Lista de Desejos</title>
</head>
<body>

<div>
    <nav>
        <a href="pedidos.html">Pedidos</a>
        <a href="itens-pedido.html">Itens</a>
        <a href="lista-desejos.html">Desejos</a>
        <a href="chaves-digitais.html">Chaves</a>
    </nav>

    <div>
        <h2>Adicionar aos Desejos</h2>
        <div>
            <div class="form-group">
                <label>ID Usuário</label>
                <input type="number" id="usuarioId">
            </div>
            <div>
                <label>ID Jogo</label>
                <input type="number" id="jogoId">
            </div>
        </div>
        <button onclick="adicionar()">Adicionar</button>
    </div>

    <div>
        <h2>Lista de Todos os Usuários</h2>
        <table>
            <thead>
            <tr>
                <th>Usuário</th>
                <th>Jogo</th>
                <th>Data Adição</th>
                <th>Ações</th>
            </tr>
            </thead>
            <tbody id="tabela-desejos"></tbody>
        </table>
    </div>
</div>

<script>
    const API_URL = '/lista-desejos';

    function getXmlValue(node, tagName) {
        const tag = node.querySelector(tagName);
        return tag ? tag.textContent : '';
    }

    function getNestedId(node, parentTag) {
        const parent = node.querySelector(parentTag);
        return parent ? (getXmlValue(parent, 'id')) : '';
    }

    async function carregarLista() {
        try {
            const res = await fetch(API_URL, { headers: { 'Accept': 'application/xml' } });
            const text = await res.text();
            const xmlDoc = new DOMParser().parseFromString(text, "text/xml");
            const nodes = xmlDoc.querySelectorAll("itemListaDesejo, item");

            const tbody = document.getElementById('tabela-desejos');
            tbody.innerHTML = '';

            nodes.forEach(node => {
                const usuarioId = getNestedId(node, 'usuario');
                const jogoId = getNestedId(node, 'jogo');
                const data = getXmlValue(node, 'adicionadoEm');

                tbody.innerHTML += `
                    <tr>
                        <td>ID: ${usuarioId}</td>
                        <td>ID: ${jogoId}</td>
                        <td>${data}</td>
                        <td>
                            <button class="btn-delete" onclick="remover(${usuarioId}, ${jogoId})">Remover</button>
                        </td>
                    </tr>
                `;
            });
        } catch(e) { console.error(e); }
    }

    async function adicionar() {
        const usuarioId = document.getElementById('usuarioId').value;
        const jogoId = document.getElementById('jogoId').value;

        const xmlBody = `
            <itemListaDesejo>
                <usuario><id>${usuarioId}</id></usuario>
                <jogo><id>${jogoId}</id></jogo>
            </itemListaDesejo>
        `;

        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/xml', 'Accept': 'application/xml' },
                body: xmlBody
            });
            if (res.ok) {
                alert('Adicionado!');
                carregarLista();
            } else {
                alert('Erro (Talvez já exista).');
            }
        } catch(e) { console.error(e); }
    }

    async function remover(uid, jid) {
        if(confirm('Remover da lista?')) {
            await fetch(`${API_URL}/usuario/${uid}/jogo/${jid}`, { method: 'DELETE' });
            carregarLista();
        }
    }

    carregarLista();
</script>
</body>
</html>